<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.winter.app.product.ProductDAO">
       
       <!-- 1. 상세 조회 (Detail) -->
       <select id="detail" resultType="ProductDTO" parameterType="ProductDTO">
          SELECT * FROM product 
          WHERE 
          product_num=#{productNum}
       </select>
       
       <!-- 2. 전체 개수 조회 (Count) - 검색 기능 반영 -->
       <select id="count" resultType="Long" parameterType="Pager">
             SELECT COUNT(product_num) FROM product
                <!-- <where> 태그를 사용하여 WHERE 구문 오류를 방지합니다. -->
                <where>
                 <if test="kind != null and search != null and search != ''">
                     <if test="kind == 'k1'">
                         product_title LIKE concat('%',#{search},'%')
                     </if>
                     <if test="kind == 'k2'">
                         product_name LIKE concat('%',#{search},'%')
                     </if>
                     <if test="kind == 'k3'">
                         product_category LIKE concat('%',#{search},'%')
                     </if>
                 </if>
                </where>
         </select>
         
       <!-- 3. 목록 조회 (List) - 페이징 및 검색 기능 반영 -->
       <select id="list" resultType="ProductDTO" parameterType="Pager">
          SELECT * FROM product
          <where>
              <if test="kind != null and search != null and search != ''">
                     <if test="kind == 'k1'">
                         product_title LIKE concat('%',#{search},'%')
                     </if>
                     <if test="kind == 'k2'">
                         product_name LIKE concat('%',#{search},'%')
                     </if>
                     <if test="kind == 'k3'">
                         product_category LIKE concat('%',#{search},'%')
                     </if>
                 </if>
          </where>
          
          ORDER BY product_num DESC
          LIMIT #{startNum}, #{perPage}
       </select>

       <!-- 4. 데이터 추가 (Add) -->
       <insert id="add" parameterType="ProductDTO">
          INSERT INTO product (product_title, product_name, product_category, product_rate, product_sale)
          VALUES (
                #{productTitle}, 
                #{productName}, 
                #{productCategory}, 
                #{productRate}, 
                #{productSale}
            )
       </insert>
       
       <!-- 5. 데이터 삭제 (Delete) -->
       <delete id="delete" parameterType="ProductDTO">
          DELETE FROM product WHERE product_num=#{productNum} 
       </delete>
       
       <!-- 6. 데이터 수정 (Update) -->
       <update id="update" parameterType="ProductDTO">
          UPDATE product 
            SET 
                product_title=#{productTitle}, 
                product_name=#{productName},
                product_category=#{productCategory},
                product_rate=#{productRate},
                product_sale=#{productSale}
          WHERE product_num=#{productNum}
       </update>
  
       
    	<!-- 댓글 -->
    	<select id="commentList" parameterType="java.util.Map" resultType="ProductCommentDTO">
    		SELECT * FROM comment
    		WHERE product_num=#{productNum}
    		ORDER BY board_num DESC
    		LIMIT #{pager.startNum}, #{pager.perPage}
    	</select>
    	
    	<insert id="commentAdd" parameterType="ProductCommentDTO">
    		INSERT INTO comment
    		VALUES (null, #{boardContents}, now(), #{productNum}, #{username})
    	</insert>
    	
    </mapper>